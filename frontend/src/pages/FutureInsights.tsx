import { useEffect, useMemo, useState } from 'react'
import { Card, Col, Row, Statistic, Typography, Slider, Select, Button, Space, message, Tag, InputNumber, Progress, Alert, Timeline, Divider, Avatar, Checkbox, Calendar, Badge, Modal, Form, Input, Rate, Tabs, List, Popover } from 'antd'
import ReactECharts from 'echarts-for-react'
import axios from 'axios'
import { ClockCircleOutlined, HeartOutlined, AppleOutlined, HomeOutlined, CarOutlined, SmileOutlined, TrophyOutlined, FireOutlined, StarOutlined, CheckCircleOutlined, ExclamationCircleOutlined, CalendarOutlined, BarChartOutlined, PieChartOutlined } from '@ant-design/icons'

type PersonaTheme = { color: string; glow: number; tone?: string }
type Persona = { title: string; description?: string; theme: PersonaTheme }

type Insights = {
  userId: number
  currentScore: number
  horizonMonths: number
  baselineCurve: number[]
  potentialCurve: number[]
  effectBreakdown: { name: string; delta: number }[]
  persona: { baseline: Persona; potential: Persona }
  whatIfConfig: any
}

type DailyPlanItem = {
  time: string
  category: string
  activity: string
  score: number
  feedback: string
  icon: string
  completed?: boolean
}

type SimulationResult = {
  scoreIncrease: number
  feedback: string
  dailyBreakdown: { day: number; score: number; feedback: string }[]
  dailyPlan: DailyPlanItem[]
}

const api = axios.create({ baseURL: '/api' })

export default function FutureInsights() {
  const [loading, setLoading] = useState(false)
  const [data, setData] = useState<Insights | null>(null)
  const [controls, setControls] = useState({
    // ÂÇ®ËìÑ (Savings)
    savings_increase: 1000,
    savings_frequency: 1,
    emergency_fund_target: 6,
    // ÊäïËµÑ (Investment)
    investment_increase: 500,
    investment_frequency: 1,
    risk_tolerance_adjust: 2,
    // ÂÄ∫Âä° (Debt)
    debt_reduction: 2000,
    debt_payment_frequency: 1,
    debt_consolidation: false,
    // Êî∂ÂÖ• (Income)
    side_income: 500,
    income_frequency: 1,
    career_advancement: 1,
    // ÊîØÂá∫ (Expenses)
    expense_reduction: 300,
    expense_frequency: 1,
    budget_tracking: 5,
    // ‰øùÈô© (Insurance)
    insurance_coverage: 2,
    insurance_frequency: 1,
    risk_management: 3,
    // ÂÖ∂‰ªñ
    financial_education: 2,
    retirement_age_adjust: 65
  })
  const [simulationDays, setSimulationDays] = useState(30)
  const [simulationResult, setSimulationResult] = useState<SimulationResult | null>(null)
  const [realTimeUpdate, setRealTimeUpdate] = useState(false)
  const [dailyPlanCompleted, setDailyPlanCompleted] = useState<Record<number, boolean>>({})
  const [todayScore, setTodayScore] = useState(0)
  const [monthlyScore, setMonthlyScore] = useState(0)
  const [achievements, setAchievements] = useState<string[]>([])
  const [currentDay, setCurrentDay] = useState(1)
  const [feedbackModal, setFeedbackModal] = useState<{visible: boolean, item?: DailyPlanItem, index?: number}>({visible: false})
  const [taskRatings, setTaskRatings] = useState<Record<number, number>>({})
  const [feedbackText, setFeedbackText] = useState('')

  useEffect(() => {
    (async () => {
      setLoading(true)
      try {
        const res = await api.get<Insights>('/future-insights/1')
        const d = res.data
        setData(d)
        // ÂàùÂßãÂåñÊéß‰ª∂
        const cfg = d.whatIfConfig
        setControls({
          savings_increase: cfg.savings?.default || 1000,
          savings_frequency: cfg.savings_frequency?.default || 1,
          emergency_fund_target: cfg.emergency_fund?.default || 6,
          investment_increase: cfg.investment?.default || 500,
          investment_frequency: cfg.investment_frequency?.default || 1,
          risk_tolerance_adjust: cfg.risk_tolerance?.default || 2,
          debt_reduction: cfg.debt?.default || 2000,
          debt_payment_frequency: cfg.debt_frequency?.default || 1,
          debt_consolidation: cfg.debt_consolidation?.default || false,
          side_income: cfg.side_income?.default || 500,
          income_frequency: cfg.income_frequency?.default || 1,
          career_advancement: cfg.career?.default || 1,
          expense_reduction: cfg.expense?.default || 300,
          expense_frequency: cfg.expense_frequency?.default || 1,
          budget_tracking: cfg.budget?.default || 5,
          insurance_coverage: cfg.insurance?.default || 2,
          insurance_frequency: cfg.insurance_frequency?.default || 1,
          risk_management: cfg.risk_management?.default || 3,
          financial_education: cfg.financial_education?.default || 2,
          retirement_age_adjust: cfg.retirement_age?.default || 65
        })
      } catch (e: any) {
        message.error(e?.message || 'Âä†ËΩΩÂ§±Ë¥•')
      } finally {
        setLoading(false)
      }
    })()
  }, [])

  const trendOption = useMemo(() => {
    if (!data) return {}
    const months = Array.from({ length: data.horizonMonths }, (_, i) => `${i + 1}Êúà`)
    return {
      tooltip: { trigger: 'axis' },
      legend: { data: ['Áª¥ÊåÅÁé∞Áä∂', 'ÊΩúËÉΩÊøÄÂèë'] },
      grid: { left: 40, right: 24, bottom: 30, top: 30 },
      xAxis: { type: 'category', data: months, boundaryGap: false },
      yAxis: { type: 'value', min: 0, max: 100 },
      series: [
        { name: 'Áª¥ÊåÅÁé∞Áä∂', type: 'line', smooth: true, data: data.baselineCurve, lineStyle: { color: '#bdc3c7' } },
        { name: 'ÊΩúËÉΩÊøÄÂèë', type: 'line', smooth: true, data: data.potentialCurve, lineStyle: { color: '#16a085' }, areaStyle: { color: 'rgba(22,160,133,0.12)' } }
      ]
    }
  }, [data])

  const effectsOption = useMemo(() => {
    if (!data) return {}
    return {
      tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
      grid: { left: 60, right: 24, bottom: 30, top: 10 },
      xAxis: { type: 'value' },
      yAxis: { type: 'category', data: data.effectBreakdown.map(i => i.name) },
      series: [{ type: 'bar', data: data.effectBreakdown.map(i => i.delta), barWidth: 16, itemStyle: { color: '#3498db' } }]
    }
  }, [data])

  const progressChartOption = useMemo(() => {
    if (!simulationResult) return {}
    const completed = Object.values(dailyPlanCompleted).filter(Boolean).length
    const total = simulationResult.dailyPlan.length
    return {
      series: [{
        type: 'pie',
        radius: ['40%', '70%'],
        data: [
          { value: completed, name: 'Â∑≤ÂÆåÊàê', itemStyle: { color: '#52c41a' } },
          { value: total - completed, name: 'Êú™ÂÆåÊàê', itemStyle: { color: '#f0f0f0' } }
        ],
        label: {
          formatter: '{b}: {c} ({d}%)'
        }
      }]
    }
  }, [simulationResult, dailyPlanCompleted])

  const categoryChartOption = useMemo(() => {
    if (!simulationResult) return {}
    const categories = ['ÂøÉ', 'È£ü', '‰Ωè', 'Ë°å', 'Ë°£']
    const categoryData = categories.map(cat => ({
      name: cat,
      value: simulationResult.dailyPlan.filter(item => item.category === cat).length
    }))
    return {
      xAxis: { type: 'category', data: categories },
      yAxis: { type: 'value' },
      series: [{ type: 'bar', data: categoryData, itemStyle: { color: '#1890ff' } }]
    }
  }, [simulationResult])

  const handleControlChange = (key: string, value: any) => {
    setControls(c => ({ ...c, [key]: value }))
    if (realTimeUpdate) {
      // Âª∂ËøüÊ®°Êãü‰ª•ÈÅøÂÖçÈ¢ëÁπÅË∞ÉÁî®
      setTimeout(() => simulate(), 500)
    }
  }

  const handlePlanItemToggle = (index: number, completed: boolean) => {
    setDailyPlanCompleted(prev => ({ ...prev, [index]: completed }))
    // ÈáçÊñ∞ËÆ°ÁÆóÂΩìÊó•ÂæóÂàÜ
    const newCompleted = { ...dailyPlanCompleted, [index]: completed }
    if (simulationResult) {
      const completedItems = simulationResult.dailyPlan.filter((_, idx) => newCompleted[idx])
      const totalScore = completedItems.reduce((sum, item) => sum + item.score, 0)
      const maxPossibleScore = simulationResult.dailyPlan.reduce((sum, item) => sum + item.score, 0)
      const todayScore = maxPossibleScore > 0 ? Math.round((totalScore / maxPossibleScore) * 100) : 0
      setTodayScore(todayScore)
      // Êú¨ÊúàÂæóÂàÜÊöÇÊó∂ÁÆÄÂçïÁ¥ØÂä†ÔºåÂÆûÈôÖÂèØ‰ª•‰ªélocalStorageÊàñÂêéÁ´ØËé∑ÂèñÂéÜÂè≤
      setMonthlyScore(prev => prev + (completed ? todayScore : -todayScore))

      // Ê£ÄÊü•ÊàêÂ∞±
      checkAchievements(newCompleted)
    }
  }

  const checkAchievements = (completed: Record<number, boolean>) => {
    const newAchievements = [...achievements]
    const completedCount = Object.values(completed).filter(Boolean).length
    const totalTasks = simulationResult?.dailyPlan.length || 0

    if (completedCount === totalTasks && !newAchievements.includes('ÂÖ®Â§©Ëææ‰∫∫')) {
      newAchievements.push('ÂÖ®Â§©Ëææ‰∫∫')
      message.success('üéâ ÊÅ≠ÂñúËé∑Âæó"ÂÖ®Â§©Ëææ‰∫∫"ÊàêÂ∞±ÔºÅ')
    }
    if (completedCount >= 5 && !newAchievements.includes('È´òÊïàÊâßË°åËÄÖ')) {
      newAchievements.push('È´òÊïàÊâßË°åËÄÖ')
      message.success('üéâ ÊÅ≠ÂñúËé∑Âæó"È´òÊïàÊâßË°åËÄÖ"ÊàêÂ∞±ÔºÅ')
    }
    setAchievements(newAchievements)
  }

  const handleFeedbackSubmit = (values: any) => {
    // ËøôÈáåÂèØ‰ª•ÂèëÈÄÅÂèçÈ¶àÂà∞ÂêéÁ´Ø
    console.log('Feedback:', values)
    message.success('ÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶àÔºÅ')
    setFeedbackModal({visible: false})
  }

  const simulate = async () => {
    if (!data) return
    setLoading(true)
    try {
      const res = await api.post(`/future-insights/${data.userId}/simulate`, { ...controls, days: simulationDays })
      const d: SimulationResult = res.data
      setSimulationResult(d)
      // Êõ¥Êñ∞ÊΩúËÉΩÁîªÂÉèÂíåÊõ≤Á∫øÔºàÂÅáËÆæÂêéÁ´ØËøîÂõûÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆÔºâ
      // ËøôÈáåÁÆÄÂåñÔºåÂÆûÈôÖÂèØËÉΩÈúÄË¶ÅÂêéÁ´ØËøîÂõûÊñ∞ÁöÑpersonaÂíåcurve
      message.success(`Ê®°ÊãüÂÆåÊàêÔºÅÂÖªËÄÅÈáëÊèêÂçá ${d.scoreIncrease} ÂàÜ`)
    } catch (e: any) {
      message.error(e?.message || 'Ê®°ÊãüÂ§±Ë¥•')
    } finally {
      setLoading(false)
    }
  }

  const personaCard = (p: Persona, title: string) => (
    <Card
      bordered
      style={{
        height: '100%',
        background: `linear-gradient(135deg, ${p.theme.color}20, ${p.theme.color}10)`,
        border: `2px solid ${p.theme.color}40`,
        position: 'relative',
        overflow: 'hidden'
      }}
    >
      <div style={{
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: `radial-gradient(circle at 30% 30%, ${p.theme.color}15, transparent 70%)`,
        zIndex: 0
      }} />
      <Space direction="vertical" size={8} style={{ width: '100%', position: 'relative', zIndex: 1 }}>
        <Tag color={title === 'ÊΩúËÉΩÊøÄÂèë' ? 'green' : 'default'} style={{ alignSelf: 'flex-start' }}>{title}</Tag>
        <div style={{
          height: 80,
          borderRadius: 12,
          background: `linear-gradient(45deg, ${p.theme.color}, ${p.theme.color}80)`,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          boxShadow: `0 0 20px ${p.theme.color}40`,
          margin: '8px 0'
        }}>
          <Typography.Title level={3} style={{ color: '#fff', margin: 0, textShadow: '0 2px 4px rgba(0,0,0,0.3)' }}>
            {p.title}
          </Typography.Title>
        </div>
        {p.description && (
          <Typography.Paragraph
            style={{
              color: 'var(--primary-text)',
              marginBottom: 0,
              textAlign: 'center',
              fontStyle: 'italic'
            }}
          >
            {p.description}
          </Typography.Paragraph>
        )}
      </Space>
    </Card>
  )

  return (
    <Space direction="vertical" size={16} style={{ width: '100%' }}>
      <Row gutter={16}>
        <Col xs={24} md={12}>{personaCard(data?.persona.baseline || { title: '', theme: { color: '#ccc', glow: .5 } }, 'Áª¥ÊåÅÁé∞Áä∂')}</Col>
        <Col xs={24} md={12}>{personaCard(data?.persona.potential || { title: '', theme: { color: '#ccc', glow: .5 } }, 'ÊΩúËÉΩÊøÄÂèë')}</Col>
      </Row>

      <Row gutter={16}>
        <Col xs={24} lg={16}>
          <Card title="Êú™Êù•ÂÖªËÄÅÈáëË∂ãÂäø" loading={loading}>
            <ReactECharts option={trendOption} style={{ height: 320 }} notMerge lazyUpdate></ReactECharts>
          </Card>
        </Col>
        <Col xs={24} lg={8}>
          <Card title="ÂΩìÂâçÂàÜÊï∞" loading={loading}>
            <Statistic title="ÂÖªËÄÅÈáëÊÄªÂàÜ" value={data?.currentScore || 0} suffix="/100" />
          </Card>
          <Card title="Ë°å‰∏∫ÂΩ±ÂìçÊãÜËß£" style={{ marginTop: 16 }} loading={loading}>
            <ReactECharts option={effectsOption} style={{ height: 240 }} notMerge lazyUpdate></ReactECharts>
          </Card>
        </Col>
      </Row>

      <Card title={<Space><SmileOutlined /> Ë°£È£ü‰ΩèË°åÂøÉ ÂÖ®Â§©Ë°å‰∏∫Ê®°Êãü</Space>} loading={loading} style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' }}>
        <Space direction="vertical" size={16} style={{ width: '100%' }}>
          <Row gutter={16}>
            <Col xs={24} md={12}>
              <Typography.Text style={{ color: 'white' }}>Ê®°ÊãüÂ§©Êï∞: {simulationDays} Â§©</Typography.Text>
              <Slider min={1} max={90} value={simulationDays} onChange={setSimulationDays} />
            </Col>
            <Col xs={24} md={12}>
              <Typography.Text style={{ color: 'white' }}>ÂÆûÊó∂Êõ¥Êñ∞</Typography.Text>
              <Select value={realTimeUpdate} onChange={setRealTimeUpdate} style={{ width: '100%' }}>
                <Select.Option value={false}>ÊâãÂä®Ê®°Êãü</Select.Option>
                <Select.Option value={true}>ÊãñÂä®ÂÆûÊó∂Êõ¥Êñ∞</Select.Option>
              </Select>
            </Col>
          </Row>

          {/* ÂÇ®ËìÑ (Savings) */}
          <Card size="small" title={<Space><HeartOutlined style={{ color: '#ff6b6b' }} /> üí∞ ÂÇ®ËìÑ - ÂÇ®ËìÑ‰∏éÂ∫îÊÄ•Âü∫Èáë</Space>} style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}>
            <Row gutter={16}>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÂÇ®ËìÑÂ¢ûÂä† (ÂÖÉ/Êúà): {controls.savings_increase}</Typography.Text>
                <Slider min={0} max={5000} step={100} value={controls.savings_increase} onChange={(v) => handleControlChange('savings_increase', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÂÇ®ËìÑÈ¢ëÁéá (Ê¨°/Êúà): {controls.savings_frequency}</Typography.Text>
                <Slider min={1} max={12} value={controls.savings_frequency} onChange={(v) => handleControlChange('savings_frequency', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>Â∫îÊÄ•Âü∫ÈáëÁõÆÊ†á (Êúà): {controls.emergency_fund_target}</Typography.Text>
                <Slider min={3} max={12} value={controls.emergency_fund_target} onChange={(v) => handleControlChange('emergency_fund_target', v)} />
              </Col>
            </Row>
          </Card>

          {/* ÊäïËµÑ (Investment) */}
          <Card size="small" title={<Space><AppleOutlined style={{ color: '#51cf66' }} /> üìà ÊäïËµÑ - ÊäïËµÑ‰∏éËµÑ‰∫ßÈÖçÁΩÆ</Space>} style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}>
            <Row gutter={16}>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÊäïËµÑÂ¢ûÂä† (ÂÖÉ/Êúà): {controls.investment_increase}</Typography.Text>
                <Slider min={0} max={2000} step={50} value={controls.investment_increase} onChange={(v) => handleControlChange('investment_increase', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÊäïËµÑÈ¢ëÁéá (Ê¨°/Êúà): {controls.investment_frequency}</Typography.Text>
                <Slider min={1} max={12} value={controls.investment_frequency} onChange={(v) => handleControlChange('investment_frequency', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>È£éÈô©ÊâøÂèóË∞ÉÊï¥ (1-5): {controls.risk_tolerance_adjust}</Typography.Text>
                <Slider min={1} max={5} value={controls.risk_tolerance_adjust} onChange={(v) => handleControlChange('risk_tolerance_adjust', v)} />
              </Col>
            </Row>
          </Card>

          {/* ÂÄ∫Âä° (Debt) */}
          <Card size="small" title={<Space><HomeOutlined style={{ color: '#74c0fc' }} /> üí≥ ÂÄ∫Âä° - ÂÄ∫Âä°ÁÆ°ÁêÜ‰∏éÂÅøËøò</Space>} style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}>
            <Row gutter={16}>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÂÄ∫Âä°ÂáèÂ∞ë (ÂÖÉ/Êúà): {controls.debt_reduction}</Typography.Text>
                <Slider min={0} max={5000} step={100} value={controls.debt_reduction} onChange={(v) => handleControlChange('debt_reduction', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ËøòÊ¨æÈ¢ëÁéá (Ê¨°/Êúà): {controls.debt_payment_frequency}</Typography.Text>
                <Slider min={1} max={12} value={controls.debt_payment_frequency} onChange={(v) => handleControlChange('debt_payment_frequency', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÂÄ∫Âä°Êï¥Âêà</Typography.Text>
                <Select style={{ width: '100%' }} value={controls.debt_consolidation} onChange={(v) => handleControlChange('debt_consolidation', v)} options={[
                  { value: false, label: 'Âê¶' }, { value: true, label: 'ÊòØ' }
                ]} />
              </Col>
            </Row>
          </Card>

          {/* Êî∂ÂÖ• (Income) */}
          <Card size="small" title={<Space><CarOutlined style={{ color: '#ffd43b' }} /> üíº Êî∂ÂÖ• - Êî∂ÂÖ•Â¢ûÈïø‰∏éÂâØ‰∏ö</Space>} style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}>
            <Row gutter={16}>
              <Col xs={24} md={6}>
                <Typography.Text style={{ color: 'white' }}>ÂâØ‰∏öÊî∂ÂÖ• (ÂÖÉ/Êúà): {controls.side_income}</Typography.Text>
                <Slider min={0} max={2000} step={50} value={controls.side_income} onChange={(v) => handleControlChange('side_income', v)} />
              </Col>
              <Col xs={24} md={6}>
                <Typography.Text style={{ color: 'white' }}>Êî∂ÂÖ•È¢ëÁéá (Ê¨°/Êúà): {controls.income_frequency}</Typography.Text>
                <Slider min={1} max={12} value={controls.income_frequency} onChange={(v) => handleControlChange('income_frequency', v)} />
              </Col>
              <Col xs={24} md={6}>
                <Typography.Text style={{ color: 'white' }}>ËÅå‰∏öÂèëÂ±ï (1-5): {controls.career_advancement}</Typography.Text>
                <Slider min={1} max={5} value={controls.career_advancement} onChange={(v) => handleControlChange('career_advancement', v)} />
              </Col>
              <Col xs={24} md={6}>
                <Typography.Text style={{ color: 'white' }}>Ë¥¢Âä°ÊïôËÇ≤ (Â∞èÊó∂/Âë®): {controls.financial_education}</Typography.Text>
                <Slider min={0} max={10} value={controls.financial_education} onChange={(v) => handleControlChange('financial_education', v)} />
              </Col>
            </Row>
          </Card>

          {/* ÊîØÂá∫ (Expenses) */}
          <Card size="small" title={<Space><ClockCircleOutlined style={{ color: '#f783ac' }} /> üí∏ ÊîØÂá∫ - ÊîØÂá∫ÊéßÂà∂‰∏éÈ¢ÑÁÆó</Space>} style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}>
            <Row gutter={16}>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÊîØÂá∫ÂáèÂ∞ë (ÂÖÉ/Êúà): {controls.expense_reduction}</Typography.Text>
                <Slider min={0} max={2000} step={50} value={controls.expense_reduction} onChange={(v) => handleControlChange('expense_reduction', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>È¢ÑÁÆóË∑üË∏™ (Â§©/Âë®): {controls.budget_tracking}</Typography.Text>
                <Slider min={1} max={7} value={controls.budget_tracking} onChange={(v) => handleControlChange('budget_tracking', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>ÈÄÄ‰ºëÂπ¥ÈæÑË∞ÉÊï¥: {controls.retirement_age_adjust}</Typography.Text>
                <Slider min={55} max={75} value={controls.retirement_age_adjust} onChange={(v) => handleControlChange('retirement_age_adjust', v)} />
              </Col>
            </Row>
          </Card>

          {/* ‰øùÈô©‰∏éÈ£éÈô©ÁÆ°ÁêÜ */}
          <Card size="small" title="üõ°Ô∏è ‰øùÈô©‰∏éÈ£éÈô©ÁÆ°ÁêÜ" style={{ background: 'rgba(255,255,255,0.1)', border: '1px solid rgba(255,255,255,0.2)' }}>
            <Row gutter={16}>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>‰øùÈô©Ë¶ÜÁõñ (1-5): {controls.insurance_coverage}</Typography.Text>
                <Slider min={1} max={5} value={controls.insurance_coverage} onChange={(v) => handleControlChange('insurance_coverage', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>‰øùÈô©È¢ëÁéá (Ê¨°/Âπ¥): {controls.insurance_frequency}</Typography.Text>
                <Slider min={1} max={12} value={controls.insurance_frequency} onChange={(v) => handleControlChange('insurance_frequency', v)} />
              </Col>
              <Col xs={24} md={8}>
                <Typography.Text style={{ color: 'white' }}>È£éÈô©ÁÆ°ÁêÜ (1-5): {controls.risk_management}</Typography.Text>
                <Slider min={1} max={5} value={controls.risk_management} onChange={(v) => handleControlChange('risk_management', v)} />
              </Col>
            </Row>
          </Card>

          <Row gutter={16}>
            <Col span={24}>
              <Button type="primary" onClick={simulate} disabled={realTimeUpdate} size="large" style={{ width: '100%', height: 50, fontSize: 18 }}>
                üöÄ Â∫îÁî®Ê®°ÊãüÂπ∂ÁîüÊàêÂÖ®Â§©ËÆ°Âàí
              </Button>
            </Col>
          </Row>
        </Space>
      </Card>

      {simulationResult && (
        <Row gutter={16}>
          <Col span={24}>
            <Alert
              message={`üéâ Ê®°ÊãüÁªìÊûú: ÂÖªËÄÅÈáëÊèêÂçá ${simulationResult.scoreIncrease} ÂàÜ`}
              description={simulationResult.feedback}
              type="success"
              showIcon
            />
          </Col>
          <Col span={24}>
            <Card title="üìä ‰ªäÊó•Ë°®Áé∞" size="small">
              <Row gutter={16}>
                <Col span={12}>
                  <Statistic
                    title="ÂΩìÊó•ÂæóÂàÜ"
                    value={todayScore}
                    suffix="/ 100"
                    valueStyle={{ color: todayScore >= 80 ? '#52c41a' : todayScore >= 60 ? '#1890ff' : '#fa8c16' }}
                  />
                  <Progress percent={todayScore} strokeColor={todayScore >= 80 ? '#52c41a' : todayScore >= 60 ? '#1890ff' : '#fa8c16'} />
                </Col>
                <Col span={12}>
                  <Statistic
                    title="Êú¨ÊúàÁ¥ØËÆ°ÂæóÂàÜ"
                    value={monthlyScore}
                    suffix="ÂàÜ"
                    valueStyle={{ color: monthlyScore >= 2000 ? '#52c41a' : monthlyScore >= 1500 ? '#1890ff' : '#fa8c16' }}
                  />
                </Col>
              </Row>
            </Card>
          </Col>
          <Col span={24}>
            <Card title="ü§ñ Êô∫ËÉΩÂÖªËÄÅÈáëË°åÂä®ÊñπÊ°à" size="small">
              <Tabs defaultActiveKey="plan" type="card">
                <Tabs.TabPane tab="üìÖ ÊØèÊó•ËÆ°Âàí" key="plan">
                  <Row gutter={16}>
                    <Col span={16}>
                      <Timeline mode="left">
                        {simulationResult.dailyPlan.map((item, idx) => (
                          <Timeline.Item key={idx} color={item.score > 7 ? 'green' : item.score > 4 ? 'blue' : 'orange'} dot={<Avatar size="small">{item.icon}</Avatar>}>
                            <Card size="small" style={{ background: dailyPlanCompleted[idx] ? '#f6ffed' : '#fff', border: dailyPlanCompleted[idx] ? '1px solid #b7eb8f' : '1px solid #d9d9d9' }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <Checkbox
                                      checked={dailyPlanCompleted[idx] || false}
                                      onChange={(e) => handlePlanItemToggle(idx, e.target.checked)}
                                    />
                                    <div>
                                      <Typography.Text strong>{item.time}</Typography.Text> - {item.activity}
                                      <br />
                                      <Typography.Text type="secondary">{item.feedback}</Typography.Text>
                                      <br />
                                      <Tag color={item.category === 'ÂøÉ' ? 'red' : item.category === 'È£ü' ? 'orange' : item.category === '‰Ωè' ? 'blue' : item.category === 'Ë°å' ? 'green' : 'purple'}>
                                        {item.category}
                                      </Tag>
                                    </div>
                                  </div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                  <Typography.Text strong style={{ color: item.score > 7 ? '#52c41a' : item.score > 4 ? '#1890ff' : '#fa8c16' }}>
                                    {item.score}/10
                                  </Typography.Text>
                                  <Progress percent={item.score * 10} size="small" showInfo={false} strokeColor={item.score > 7 ? '#52c41a' : item.score > 4 ? '#1890ff' : '#fa8c16'} />
                                  <br />
                                  <Button size="small" type="link" onClick={() => setFeedbackModal({visible: true, item, index: idx})}>
                                    ÂèçÈ¶à
                                  </Button>
                                </div>
                              </div>
                            </Card>
                          </Timeline.Item>
                        ))}
                      </Timeline>
                    </Col>
                    <Col span={8}>
                      <Space direction="vertical" style={{ width: '100%' }}>
                        <Card title="ÔøΩ ÂÆåÊàêËøõÂ∫¶" size="small">
                          <ReactECharts option={progressChartOption} style={{ height: 200 }} />
                        </Card>
                        <Card title="üìà Á±ªÂà´ÂàÜÂ∏É" size="small">
                          <ReactECharts option={categoryChartOption} style={{ height: 200 }} />
                        </Card>
                      </Space>
                    </Col>
                  </Row>
                </Tabs.TabPane>
                <Tabs.TabPane tab="üèÜ ÊàêÂ∞±Á≥ªÁªü" key="achievements">
                  <Row gutter={16}>
                    <Col span={24}>
                      <List
                        grid={{ gutter: 16, column: 4 }}
                        dataSource={achievements}
                        renderItem={(achievement) => (
                          <List.Item>
                            <Card style={{ textAlign: 'center', background: 'linear-gradient(135deg, #faad14, #f39c12)' }}>
                              <TrophyOutlined style={{ fontSize: 32, color: '#fff' }} />
                              <br />
                              <Typography.Text strong style={{ color: '#fff' }}>{achievement}</Typography.Text>
                            </Card>
                          </List.Item>
                        )}
                      />
                      {achievements.length === 0 && (
                        <div style={{ textAlign: 'center', padding: 40 }}>
                          <TrophyOutlined style={{ fontSize: 48, color: '#d9d9d9' }} />
                          <br />
                          <Typography.Text type="secondary">ÊöÇÊó†ÊàêÂ∞±ÔºåÁªßÁª≠Âä™ÂäõÂêßÔºÅ</Typography.Text>
                        </div>
                      )}
                    </Col>
                  </Row>
                </Tabs.TabPane>
                <Tabs.TabPane tab="üìà ËøõÂ∫¶ËøΩË∏™" key="progress">
                  <Row gutter={16}>
                    <Col span={12}>
                      <Card title="Êú¨Âë®ËøõÂ∫¶" size="small">
                        <Calendar
                          fullscreen={false}
                          dateCellRender={(date) => {
                            const day = date.date()
                            const completed = day <= currentDay ? Math.floor(Math.random() * 10) + 1 : 0
                            return completed > 0 ? (
                              <div style={{ textAlign: 'center' }}>
                                <Badge count={completed} color="#52c41a" />
                              </div>
                            ) : null
                          }}
                        />
                      </Card>
                    </Col>
                    <Col span={12}>
                      <Card title="ÊúàÂ∫¶ÁªüËÆ°" size="small">
                        <Statistic title="Êú¨ÊúàÂÆåÊàêÂ§©Êï∞" value={currentDay} suffix="/ 30" />
                        <Statistic title="Âπ≥ÂùáÊØèÊó•ÂæóÂàÜ" value={Math.round(monthlyScore / Math.max(currentDay, 1))} />
                        <Statistic title="ËøûÁª≠ÂÆåÊàêÂ§©Êï∞" value={3} />
                        <Statistic title="ÊúÄÈ´òÂçïÊó•ÂæóÂàÜ" value={95} />
                      </Card>
                    </Col>
                  </Row>
                </Tabs.TabPane>
              </Tabs>
            </Card>
          </Col>
        </Row>
      )}

      {/* ÂèçÈ¶àÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title="‰ªªÂä°ÂèçÈ¶à"
        open={feedbackModal.visible}
        onOk={() => handleFeedbackSubmit(feedbackModal.index || 0)}
        onCancel={() => setFeedbackModal({visible: false})}
        okText="Êèê‰∫§"
        cancelText="ÂèñÊ∂à"
      >
        {feedbackModal.item && feedbackModal.index !== undefined && (
          <Form layout="vertical">
            <Form.Item label="‰ªªÂä°">
              <Typography.Text>{feedbackModal.item.time} - {feedbackModal.item.activity}</Typography.Text>
            </Form.Item>
            <Form.Item label="ËØÑÂàÜ (1-10)">
              <Rate
                value={taskRatings[feedbackModal.index] || feedbackModal.item.score}
                onChange={(value) => {
                  setTaskRatings(prev => ({...prev, [feedbackModal.index!]: value}))
                }}
              />
            </Form.Item>
            <Form.Item label="ÂèçÈ¶àÊÑèËßÅ">
              <Input.TextArea
                placeholder="ËØ∑ÂàÜ‰∫´ÊÇ®ÁöÑÊâßË°å‰ΩìÈ™åÂíåÂª∫ËÆÆ..."
                rows={4}
                value={feedbackText}
                onChange={(e) => setFeedbackText(e.target.value)}
              />
            </Form.Item>
          </Form>
        )}
      </Modal>

    </Space>
  )
}
